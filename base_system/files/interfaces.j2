# /etc/network/interfaces

# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

auto lo
iface lo inet loopback

{% if network_type == "wifi" %}
iface {{ ethernet_interface }} inet manual
{% endif %}
{% if network_type == "ethernet" %}
auto {{ ethernet_interface }}
iface {{ ethernet_interface }} inet dhcp
	post-up echo 1 > /proc/sys/net/ipv4/ip_forward
	post-up echo 1 > /proc/sys/net/ipv4/conf/{{ ethernet_interface }}/proxy_arp
{% endif %}

auto {{ wifi_interface }}
{% if network_type == "wifi" %}
iface {{ wifi_interface }} inet dhcp
	wpa-driver nl80211
	wpa-ssid {{ ssid }}
	wpa-psk {{ wpa_psk }}

{% endif %}
{% if network_type == "ethernet" %}
iface {{ wifi_interface }} inet manual
{% endif %}
	pre-up iw dev {{ wifi_interface }} interface add wlan_ap type __ap
	post-up hostapd -B /root/hostapd.conf

# Used as WAN in PFSense
auto vmbr0
iface vmbr0 inet static
	address 10.10.100.1/24
	bridge-ports none
	bridge-stp off
	bridge-fd 0

	post-up echo 1 >> /proc/sys/net/ipv4/ip_forward
{% if network_type == "wifi" %}
	post-up iptables -t nat -A POSTROUTING -s '10.10.100.0/24' -o {{ wifi_interface }} -j MASQUERADE
	post-down iptables -t nat -D POSTROUTING -s '10.10.100.0/24' -o {{ wifi_interface }} -j MASQUERADE
{% endif %}
{% if network_type == "ethernet" %}
	post-up iptables -t nat -A POSTROUTING -s '10.10.100.0/24' -o {{ ethernet_interface }} -j MASQUERADE
	post-down iptables -t nat -D POSTROUTING -s '10.10.100.0/24' -o {{ ethernet_interface }} -j MASQUERADE
{% endif %}
	post-up iptables -t raw -I PREROUTING -i fwbr+ -j CT --zone 1
	post-down iptables -t raw -D PREROUTING -i fwbr+ -j CT --zone 1

# Used as LAN (for devices on the WIFI) in PFSense
auto vmbr1
iface vmbr1 inet manual
	bridge-ports wlan_ap
	bridge-stp off
	bridge-fd 0

## Following are optional interfaces to segregate traffic from VMs

# Used as LAN2 (for VMs) in PFSense
auto vmbr2
iface vmbr2 inet manual
	bridge-ports none
	bridge-stp off
	bridge-fd 0

# Used as LAN3 (for Windows VMs) in PFSense
auto vmbr3
iface vmbr3 inet manual
	bridge-ports none
	bridge-stp off
	bridge-fd 0

# Used as DLAN (retricted without WAN access) in PFSense
auto vmbr4
iface vmbr4 inet manual
	bridge-ports none
	bridge-stp off
	bridge-fd 0

source /etc/network/interfaces.d/*
